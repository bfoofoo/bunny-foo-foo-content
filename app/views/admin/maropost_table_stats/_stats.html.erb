<%- if table_data[:cells].empty? %>
  <h2>There is no data for selected filters.</h2>
<% else %>
  <% max_value = table_data[:max_value] %>
  <% table_data[:cells].each do |date, by_date| %>
    <h3><%= date  %></h3>
    <table class="index_table index stats_table">
      <thead>
      <tr>
        <th></th>
        <% by_date.each do |_, campaign_data| %>
          <th colspan="<%= table_data[:types].count %>">
            <%= campaign_data['sent_at']&.in_time_zone&.strftime('%l %P')&.strip %>
          </th>
        <% end %>
      </tr>
      <% if by_date.first.last['subject'] %>
        <tr>
          <th></th>
          <% by_date.each do |_, campaign_data| %>
            <th colspan="<%= table_data[:types].count %>"><%= campaign_data['subject'] %></th>
          <% end %>
        </tr>
      <% end %>
      <tr>
        <th></th>
        <% by_date.each do %>
          <% table_data[:types].each do |type| %>
            <th><%= t("esp_stats_table.#{type}") %></th>
          <% end %>
        <% end %>
      </tr>
      </thead>
      <tbody>
      <% table_data[:affiliates].each do |a| %>
        <tr>
          <td class="border-right">
            <%= a ? "A=#{a}" : 'No affiliate' %>
          </td>
          <% by_date.each do |_, campaign_data| %>
            <% table_data[:types].each_with_index do |type, index| %>
              <% sum = campaign_data.dig('affiliates', a, type) || 0 %>
              <td class="<%= 'border-right' if index == (table_data[:types].size - 1) %> <%= 'non-empty' if sum > 0 %>" style="<%= colorize_cell(max_value, sum) %>">
                <%= sum %>
              </td>
            <% end %>
          <% end %>
        </tr>
      <% end %>
      <tr>
        <td class="border-right">
          <b>Total</b>
        </td>
        <% by_date.each do |_, by_hour| %>
          <% table_data[:types].each_with_index do |type, index| %>
            <% sum = by_hour.dig('total', type) || 0 %>
            <td class="<%= 'border-right' if index == (table_data[:types].size - 1) %> <%= 'non-empty' if sum > 0 %>" style="<%= colorize_cell(max_value, sum) %>">
              <%= sum %>
            </td>
          <% end %>
        <% end %>
      </tr>
      </tbody>
    </table>
  <% end %>
<% end %>
